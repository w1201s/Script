-- Custom Modal-Like UI Library v4 (by you, bro) - Smooth Animations, No Lag
local UserInputService = game:GetService("UserInputService")
local TweenService = game:GetService("TweenService")
local Players = game:GetService("Players")
local HttpService = game:GetService("HttpService")
local player = Players.LocalPlayer
local guiParent = player:WaitForChild("PlayerGui")

-- ScreenGui
local screenGui = Instance.new("ScreenGui")
screenGui.Name = "CustomModalUI"
screenGui.ResetOnSpawn = false
screenGui.IgnoreGuiInset = true
screenGui.Parent = guiParent

-- Theme
local theme = {
    Background = Color3.fromRGB(18, 18, 24),
    Accent = Color3.fromRGB(160, 100, 255),
    Text = Color3.fromRGB(230, 230, 240),
    Border = Color3.fromRGB(50, 50, 65),
    Hover = Color3.fromRGB(35, 35, 45),
    TabSelected = Color3.fromRGB(80, 80, 100),
    Transparency = 0.12
}

-- Fast & smooth tween helper
local function tween(obj, props, time, easing)
    local info = TweenInfo.new(
        time or 0.25,
        easing or Enum.EasingStyle.Sine,
        Enum.EasingDirection.Out
    )
    TweenService:Create(obj, info, props):Play()
end

-- Library
local Library = {}
local currentWindows = {}
local savedData = {
    WindowPos = UDim2.new(0.5, -240, 0.5, -260),
    WindowSize = UDim2.fromOffset(480, 520),
    OpenBtnPos = UDim2.new(0, 20, 1, -80)
}

function Library:CreateWindow(title, subtitle)
    if #currentWindows >= 2 then
        local old = table.remove(currentWindows, 1)
        if old and old.MainFrame then old.MainFrame:Destroy() end
        if old and old.OpenBtn then old.OpenBtn:Destroy() end
    end

    local window = {}
    window.Tabs = {}
    window.CurrentTab = nil
    window.IsOpen = true

    -- Main Frame
    local mainFrame = Instance.new("Frame")
    mainFrame.Name = "MainFrame"
    mainFrame.Size = savedData.WindowSize
    mainFrame.Position = savedData.WindowPos
    mainFrame.BackgroundColor3 = theme.Background
    mainFrame.BackgroundTransparency = 1  -- start hidden
    mainFrame.BorderSizePixel = 0
    mainFrame.ClipsDescendants = true
    mainFrame.Visible = true
    mainFrame.Parent = screenGui

    local corner = Instance.new("UICorner")
    corner.CornerRadius = UDim.new(0, 14)
    corner.Parent = mainFrame

    local stroke = Instance.new("UIStroke")
    stroke.Color = theme.Border
    stroke.Thickness = 1.2
    stroke.Transparency = 0.5
    stroke.Parent = mainFrame

    -- Title Bar
    local titleBar = Instance.new("Frame")
    titleBar.Size = UDim2.new(1, 0, 0, 38)
    titleBar.BackgroundColor3 = theme.Background
    titleBar.BackgroundTransparency = 0.2
    titleBar.BorderSizePixel = 0
    titleBar.Parent = mainFrame

    local titleLabel = Instance.new("TextLabel")
    titleLabel.Size = UDim2.new(0.6, 0, 1, 0)
    titleLabel.Position = UDim2.new(0, 16, 0, 0)
    titleLabel.BackgroundTransparency = 1
    titleLabel.Text = title or "Modal"
    titleLabel.TextColor3 = theme.Text
    titleLabel.Font = Enum.Font.GothamBold
    titleLabel.TextSize = 16
    titleLabel.TextXAlignment = Enum.TextXAlignment.Left
    titleLabel.Parent = titleBar

    local subLabel = Instance.new("TextLabel")
    subLabel.Size = UDim2.new(0.4, 0, 1, 0)
    subLabel.Position = UDim2.new(0.6, 0, 0, 0)
    subLabel.BackgroundTransparency = 1
    subLabel.Text = subtitle or "github.com/BloxCrypto/Modal"
    subLabel.TextColor3 = Color3.fromRGB(160, 160, 180)
    subLabel.Font = Enum.Font.Gotham
    subLabel.TextSize = 13
    subLabel.TextXAlignment = Enum.TextXAlignment.Right
    subLabel.Parent = titleBar

    -- Close Button
    local closeBtn = Instance.new("TextButton")
    closeBtn.Size = UDim2.new(0, 28, 0, 28)
    closeBtn.Position = UDim2.new(1, -36, 0, 5)
    closeBtn.BackgroundColor3 = Color3.fromRGB(200, 60, 60)
    closeBtn.Text = "X"
    closeBtn.TextColor3 = Color3.new(1,1,1)
    closeBtn.Font = Enum.Font.GothamSemibold
    closeBtn.TextSize = 16
    closeBtn.Parent = titleBar

    local closeCorner = Instance.new("UICorner")
    closeCorner.CornerRadius = UDim.new(0, 6)
    closeCorner.Parent = closeBtn

    -- Tabs
    local tabsFrame = Instance.new("Frame")
    tabsFrame.Size = UDim2.new(1, 0, 0, 36)
    tabsFrame.Position = UDim2.new(0, 0, 0, 38)
    tabsFrame.BackgroundTransparency = 1
    tabsFrame.Parent = mainFrame

    local tabsLayout = Instance.new("UIListLayout")
    tabsLayout.FillDirection = Enum.FillDirection.Horizontal
    tabsLayout.HorizontalAlignment = Enum.HorizontalAlignment.Center
    tabsLayout.Padding = UDim.new(0, 8)
    tabsLayout.Parent = tabsFrame

    -- Content
    local contentFrame = Instance.new("ScrollingFrame")
    contentFrame.Size = UDim2.new(1, 0, 1, -74)
    contentFrame.Position = UDim2.new(0, 0, 0, 74)
    contentFrame.BackgroundTransparency = 1
    contentFrame.ScrollBarThickness = 3
    contentFrame.CanvasSize = UDim2.new(0, 0, 0, 0)
    contentFrame.Parent = mainFrame

    local contentLayout = Instance.new("UIListLayout")
    contentLayout.Padding = UDim.new(0, 12)
    contentLayout.Parent = contentFrame

    contentLayout:GetPropertyChangedSignal("AbsoluteContentSize"):Connect(function()
        contentFrame.CanvasSize = UDim2.new(0, 0, 0, contentLayout.AbsoluteContentSize.Y + 24)
    end)

    -- Drag logic (title bar)
    local dragging, dragStart, startPos
    titleBar.InputBegan:Connect(function(input)
        if input.UserInputType == Enum.UserInputType.MouseButton1 or input.UserInputType == Enum.UserInputType.Touch then
            dragging = true
            dragStart = input.Position
            startPos = mainFrame.Position
            input.Changed:Connect(function() if input.UserInputState == Enum.UserInputState.End then dragging = false end end)
        end
    end)

    UserInputService.InputChanged:Connect(function(input)
        if dragging and (input.UserInputType == Enum.UserInputType.MouseMovement or input.UserInputType == Enum.UserInputType.Touch) then
            local delta = input.Position - dragStart
            mainFrame.Position = UDim2.new(startPos.X.Scale, startPos.X.Offset + delta.X, startPos.Y.Scale, startPos.Y.Offset + delta.Y)
        end
    end)

    -- Resize (bottom-right grip)
    local resizeGrip = Instance.new("ImageButton")
    resizeGrip.Size = UDim2.new(0, 24, 0, 24)
    resizeGrip.Position = UDim2.new(1, -24, 1, -24)
    resizeGrip.BackgroundTransparency = 1
    resizeGrip.Image = "rbxassetid://7072706319"  -- resize icon (arrows)
    resizeGrip.ImageTransparency = 0.4
    resizeGrip.Parent = mainFrame

    local resizing, resizeStart, startSize
    resizeGrip.InputBegan:Connect(function(input)
        if input.UserInputType == Enum.UserInputType.MouseButton1 or input.UserInputType == Enum.UserInputType.Touch then
            resizing = true
            resizeStart = input.Position
            startSize = mainFrame.Size
            input.Changed:Connect(function() if input.UserInputState == Enum.UserInputState.End then resizing = false end end)
        end
    end)

    UserInputService.InputChanged:Connect(function(input)
        if resizing and (input.UserInputType == Enum.UserInputType.MouseMovement or input.UserInputType == Enum.UserInputType.Touch) then
            local delta = input.Position - resizeStart
            mainFrame.Size = UDim2.new(
                startSize.X.Scale, math.max(320, startSize.X.Offset + delta.X),
                startSize.Y.Scale, math.max(280, startSize.Y.Offset + delta.Y)
            )
        end
    end)

    -- Animations: Open / Close
    function window:Open()
        mainFrame.Visible = true
        mainFrame.Position = savedData.WindowPos
        mainFrame.Size = savedData.WindowSize
        tween(mainFrame, {
            BackgroundTransparency = theme.Transparency,
            Size = savedData.WindowSize * UDim2.new(1.05, 0, 1.05, 0)  -- slight overshoot
        }, 0.32)
        tween(mainFrame, {Size = savedData.WindowSize}, 0.2).Completed:Wait()  -- smooth back
        window.IsOpen = true
        window.OpenBtn.Visible = false
    end

    function window:Close()
        savedData.WindowPos = mainFrame.Position
        savedData.WindowSize = mainFrame.Size
        tween(mainFrame, {
            BackgroundTransparency = 1,
            Size = savedData.WindowSize * UDim2.new(0.92, 0, 0.92, 0)
        }, 0.28)
        task.delay(0.28, function() mainFrame.Visible = false end)
        window.IsOpen = false
        window.OpenBtn.Visible = true
    end

    closeBtn.MouseButton1Click:Connect(window.Close)

    -- Key toggle (X)
    UserInputService.InputBegan:Connect(function(input, gpe)
        if gpe then return end
        if input.KeyCode == Enum.KeyCode.X then
            if window.IsOpen then window:Close() else window:Open() end
        end
    end)

    -- Open Button (draggable, larger for mobile)
    local openBtn = Instance.new("TextButton")
    openBtn.Size = UDim2.new(0, 70, 0, 70)
    openBtn.Position = savedData.OpenBtnPos
    openBtn.BackgroundColor3 = theme.Accent
    openBtn.Text = "UI"
    openBtn.TextColor3 = Color3.new(1,1,1)
    openBtn.Font = Enum.Font.GothamBold
    openBtn.TextSize = 20
    openBtn.Visible = false
    openBtn.Parent = screenGui

    local openCorner = Instance.new("UICorner")
    openCorner.CornerRadius = UDim.new(1, 0)
    openCorner.Parent = openBtn

    openBtn.MouseButton1Click:Connect(window.Open)

    -- Drag open button
    local btnDragging, btnDragStart, btnStartPos
    openBtn.InputBegan:Connect(function(input)
        if input.UserInputType == Enum.UserInputType.MouseButton1 or input.UserInputType == Enum.UserInputType.Touch then
            btnDragging = true
            btnDragStart = input.Position
            btnStartPos = openBtn.Position
            input.Changed:Connect(function() if input.UserInputState == Enum.UserInputState.End then btnDragging = false end end)
        end
    end)

    UserInputService.InputChanged:Connect(function(input)
        if btnDragging and (input.UserInputType == Enum.UserInputType.MouseMovement or input.UserInputType == Enum.UserInputType.Touch) then
            local delta = input.Position - btnDragStart
            openBtn.Position = UDim2.new(btnStartPos.X.Scale, btnStartPos.X.Offset + delta.X, btnStartPos.Y.Scale, btnStartPos.Y.Offset + delta.Y)
        end
    end)

    window.OpenBtn = openBtn
    window.MainFrame = mainFrame

    -- Add Tab with animation
    function window:AddTab(tabName)
        local tabBtn = Instance.new("TextButton")
        tabBtn.Size = UDim2.new(0, 120, 1, -6)
        tabBtn.BackgroundColor3 = theme.Hover
        tabBtn.BackgroundTransparency = 0.3
        tabBtn.Text = tabName
        tabBtn.TextColor3 = theme.Text
        tabBtn.Font = Enum.Font.GothamSemibold
        tabBtn.TextSize = 15
        tabBtn.Parent = tabsFrame

        local tabCorner = Instance.new("UICorner")
        tabCorner.CornerRadius = UDim.new(0, 8)
        tabCorner.Parent = tabBtn

        local tabContent = Instance.new("Frame")
        tabContent.Size = UDim2.new(1, 0, 1, 0)
        tabContent.BackgroundTransparency = 1
        tabContent.Visible = false
        tabContent.Parent = contentFrame

        local tabLayout = Instance.new("UIListLayout")
        tabLayout.Padding = UDim.new(0, 12)
        tabLayout.Parent = tabContent

        tabBtn.MouseButton1Click:Connect(function()
            if window.CurrentTab then
                tween(window.CurrentTab.Button, {BackgroundColor3 = theme.Hover, BackgroundTransparency = 0.3}, 0.18)
                window.CurrentTab.Content.Visible = false
            end
            tabContent.Visible = true
            tween(tabBtn, {BackgroundColor3 = theme.TabSelected, BackgroundTransparency = 0}, 0.18)
            window.CurrentTab = {Button = tabBtn, Content = tabContent}
        end)

        local tab = {}
        tab.Button = tabBtn
        tab.Content = tabContent

        function tab:AddButton(text, callback)
            local btn = Instance.new("TextButton")
            btn.Size = UDim2.new(1, -24, 0, 48)
            btn.BackgroundColor3 = theme.Hover
            btn.BackgroundTransparency = 0.2
            btn.Text = text
            btn.TextColor3 = theme.Text
            btn.Font = Enum.Font.GothamSemibold
            btn.TextSize = 16
            btn.Parent = tabContent

            local bCorner = Instance.new("UICorner")
            bCorner.CornerRadius = UDim.new(0, 10)
            bCorner.Parent = btn

            btn.MouseEnter:Connect(function()
                tween(btn, {BackgroundColor3 = theme.Accent, BackgroundTransparency = 0}, 0.15)
            end)
            btn.MouseLeave:Connect(function()
                tween(btn, {BackgroundColor3 = theme.Hover, BackgroundTransparency = 0.2}, 0.15)
            end)

            btn.MouseButton1Click:Connect(callback or function() end)
        end

        table.insert(window.Tabs, tab)
        if #window.Tabs == 1 then tabBtn:MouseButton1Click() end

        return tab
    end

    -- Notification with slide + fade
    function Library:Notify(msg, dur)
        dur = dur or 4
        local n = Instance.new("Frame")
        n.Size = UDim2.new(0, 300, 0, 60)
        n.Position = UDim2.new(1, 20, 1, -80)  -- start offscreen right
        n.BackgroundColor3 = theme.Background
        n.BackgroundTransparency = 1
        n.Parent = screenGui

        local nc = Instance.new("UICorner")
        nc.CornerRadius = UDim.new(0, 12)
        nc.Parent = n

        local nt = Instance.new("TextLabel")
        nt.Size = UDim2.new(1, -20, 1, -10)
        nt.Position = UDim2.new(0, 10, 0, 5)
        nt.BackgroundTransparency = 1
        nt.Text = msg
        nt.TextColor3 = theme.Text
        nt.TextWrapped = true
        nt.Font = Enum.Font.Gotham
        nt.TextSize = 15
        nt.Parent = n

        -- Animate in
        tween(n, {Position = UDim2.new(1, -320, 1, -80), BackgroundTransparency = 0.25}, 0.35)
        task.delay(dur, function()
            tween(n, {Position = UDim2.new(1, -320, 1, -20), BackgroundTransparency = 1}, 0.35)
            task.delay(0.35, function() n:Destroy() end)
        end)
    end

    function window:SavePositions()
        savedData.WindowPos = mainFrame.Position
        savedData.WindowSize = mainFrame.Size
        savedData.OpenBtnPos = openBtn.Position
        print("Saved (copy this JSON): " .. HttpService:JSONEncode(savedData))
    end

    table.insert(currentWindows, window)

    -- Auto open first time
    window:Open()

    return window
end
